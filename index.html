<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>VA 526EZ Maximal JSON → Page Buckets</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #0b0c0f;
            --panel: #14161a;
            --text: #e8eaed;
            --muted: #a3abb4;
            --accent: #7cc5ff;
            --chip: #223043;
            --good: #1f6f43;
            --warn: #7a4f1d;
            --bad: #7a1d2a;
            --border: #2a2f36;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 24px;
            background: var(--bg);
            color: var(--text);
            font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
        }

        h1 {
            font-size: 20px;
            margin: 0 0 16px 0;
        }

        .wrap {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 1100px) {
            .wrap {
                grid-template-columns: 360px 1fr;
            }
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, .25);
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--muted);
        }

        input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #0f1114;
            color: var(--text);
        }

        textarea {
            width: 100%;
            min-height: 200px;
            resize: vertical;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #0f1114;
            color: var(--text);
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .btn {
            appearance: none;
            border: 1px solid var(--border);
            background: #18212d;
            color: var(--text);
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn:hover {
            filter: brightness(1.1);
        }

        .btn.secondary {
            background: #11161d;
        }

        .hint {
            color: var(--muted);
            font-size: 12px;
            margin-top: 8px;
        }

        .pages {
            display: grid;
            gap: 12px;
        }

        .page {
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            background: #0f1216;
        }

        .page>summary {
            list-style: none;
            padding: 12px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(180deg, #11151a, #0f1216);
            border-bottom: 1px solid var(--border);
        }

        .page>summary::-webkit-details-marker {
            display: none;
        }

        .badge {
            background: var(--chip);
            color: var(--accent);
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid #2c3a4d;
        }

        .list {
            padding: 8px 14px 14px;
            display: grid;
            gap: 8px;
        }

        .item {
            display: grid;
            gap: 6px;
            padding: 10px 12px;
            border: 1px dashed var(--border);
            border-radius: 10px;
            background: #0d1014;
        }

        .key {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            color: #cde3ff;
            font-size: 12.5px;
        }

        .value {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            white-space: pre-wrap;
            word-break: break-word;
            color: #e5f0ff;
            background: #0b1018;
            border: 1px solid #1a2230;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 12.5px;
        }

        .pill {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            background: #151a1f;
            color: #cbd5e1;
            border: 1px solid var(--border);
            font-size: 11px;
        }

        .muted {
            color: var(--muted);
        }

        .toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .stats {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .stat {
            background: #12161c;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .footer {
            color: var(--muted);
            font-size: 12px;
            margin-top: 10px;
        }

        .search {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .search input {
            flex: 1;
        }

        .small {
            font-size: 12px;
        }
    </style>
</head>

<body>
    <h1>VA 526EZ Maximal JSON → Page Buckets</h1>

    <div class="wrap">
        <div class="card">
            <div class="toolbar">
                <button class="btn" id="btn-load-url">Fetch from URL</button>
                <button class="btn secondary" id="btn-try-sample">Load example snippet</button>
                <button class="btn" id="btn-parse">Parse JSON</button>
                <button class="btn secondary" id="btn-clear">Clear</button>
            </div>

            <label for="url" style="margin-top:12px;">JSON URL (raw)</label>
            <input id="url" type="text" placeholder="https://raw.githubusercontent.com/.../maximal-test.json" />

            <label for="json" style="margin-top:14px;">Maximal JSON</label>
            <textarea id="json" placeholder="Paste the maximal-test.json contents here"></textarea>
            <div class="hint">
                Tip: You can paste the file contents from
                <span
                    class="pill">src/applications/disability-benefits/all-claims/tests/fixtures/data/transformed-data/maximal-test.json</span>
            </div>

            <div class="search">
                <input id="filter" type="text" placeholder="Filter keys/values…" />
                <button class="btn secondary" id="btn-copy-report">Copy page names & counts</button>
            </div>

            <div class="stats" id="stats"></div>
            <div class="footer">Local-only. No data leaves your browser.</div>
        </div>

        <div class="card">
            <div id="output" class="pages"></div>
        </div>
    </div>

    <script>
        // --- PAGE RULES (tuned to 526EZ all-claims). Add/edit as needed. ---
        const PAGE_RULES = [
            { name: "Claim Type", patterns: [/^view:claimType/, /^standardClaim$/, /^view:fdcWarning/] },
            { name: "Employment / Terminal / VA Employee", patterns: [/^isVaEmployee$/, /^isTerminallyIll$/] },
            { name: "Homelessness", patterns: [/^homelessOrAtRisk/, /^view:isHomeless/, /^homelessnessContact/] },
            { name: "Contact Information", patterns: [/^phoneAndEmail/, /^mailingAddress/, /^view:hasForwardingAddress/, /^forwardingAddress/, /^view:contactInfoDescription/] },
            { name: "Direct Deposit", patterns: [/^view:bankAccount$/, /^view:originalBankAccount$/] },
            {
                name: "Evidence & Uploads", patterns: [
                    /^additionalDocuments/, /^view:uploadPrivateRecordsQualifier/, /^privateMedicalRecordAttachments/,
                    /^view:vaMedicalRecordsIntro/, /^vaTreatmentFacilities/, /^view:hasEvidence/, /^view:selectableEvidenceTypes/, /^view:evidenceTypeHelp/
                ]
            },
            {
                name: "Special Circumstances", patterns: [
                    /^view:unemployable$/, /^view:aidAndAttendance$/, /^view:modifyingHome$/, /^view:modifyingCar$/,
                    /^view:needsCarHelp/, /^view:powStatus$/, /^view:isPow/
                ]
            },
            { name: "New Disabilities", patterns: [/^newDisabilities/] },
            { name: "Rated Disabilities", patterns: [/^ratedDisabilities/, /^view:disabilitiesClarification/] },
            { name: "Service Information", patterns: [/^serviceInformation/] },
            {
                name: "PTSD Incidents & 781/781a", patterns: [
                    /^view:selectablePtsdTypes/, /^view:ptsdTypeHelp/, /^view:upload781ChoiceHelp/,
                    /^incident\d+/, /^view:upload781aChoiceHelp$/, /^secondaryIncident\d+/, /^view:otherSourcesHelp$/
                ]
            },
            { name: "Behavior Changes", patterns: [/^(physicalChanges|mentalChanges|workBehaviorChanges|socialBehaviorChanges)$/] },
            {
                name: "Unemployability (8940)", patterns: [
                    /^view:unemployabilityHelp$/, /^unemployability/, /^view:privateMedicalFacility$/, /^view:upload4192Choice$/, /^view:downloadInfo$/, /^view:privateRecordsChoiceHelp$/
                ]
            },
            { name: "FAQ / Ancillary", patterns: [/^view:ancillaryFormsWizardIntro$/, /^view:faqAccordion$/] },
        ];
        const UNMAPPED = "Unmapped";

        // --- Helpers: flatten JSON into key → value with dot-paths ---
        function flatten(obj, prefix = "") {
            const out = [];
            const isObj = v => v && typeof v === "object" && !Array.isArray(v);

            function step(value, p) {
                if (Array.isArray(value)) {
                    // Record the array itself
                    out.push({ key: p, value });
                    // Normalize children under [] for easier grouping
                    value.forEach((v, i) => {
                        const childKey = p ? `${p}[]` : "[]";
                        if (isObj(v) || Array.isArray(v)) {
                            step(v, childKey);
                        } else {
                            out.push({ key: childKey, value: v });
                        }
                    });
                } else if (isObj(value)) {
                    const keys = Object.keys(value);
                    if (p) out.push({ key: p, value }); // record node too (useful for view: blocks)
                    if (!keys.length) out.push({ key: p, value }); // empty object
                    keys.forEach(k => step(value[k], p ? `${p}.${k}` : k));
                } else {
                    out.push({ key: p, value });
                }
            }
            step(obj, prefix);
            return out;
        }

        // Top-level extraction for "data" object; tolerate being pasted with or without wrapper
        function extractDataRoot(json) {
            if (json && typeof json === "object" && "data" in json && typeof json.data === "object") {
                return json.data;
            }
            // If user pasted the inner "data" directly, use it
            return json;
        }

        // Assign a page name for a given top-level key (“rootKey”)
        function pageFor(rootKey) {
            for (const rule of PAGE_RULES) {
                if (rule.patterns.some(re => re.test(rootKey))) return rule.name;
            }
            return UNMAPPED;
        }

        // Group flattened entries by their first segment (top level) and then by page
        function groupByPages(data) {
            const flat = flatten(data); // { key: 'view:claimType.view:claimingIncrease', value: true }
            // Build a map rootKey -> entries
            const buckets = new Map();
            for (const row of flat) {
                const rootKey = (row.key || "").split(".")[0];
                if (!rootKey) continue;
                if (!buckets.has(rootKey)) buckets.set(rootKey, []);
                buckets.get(rootKey).push(row);
            }

            // Now map each rootKey to a page via PAGE_RULES
            const pages = new Map();
            for (const [rootKey, entries] of buckets.entries()) {
                const page = pageFor(rootKey);
                if (!pages.has(page)) pages.set(page, []);
                pages.get(page).push({ rootKey, entries });
            }
            return pages;
        }

        // Render utilities
        function el(tag, attrs = {}, ...children) {
            const node = document.createElement(tag);
            for (const [k, v] of Object.entries(attrs)) {
                if (k === "class") node.className = v;
                else if (k.startsWith("on") && typeof v === "function") node.addEventListener(k.substring(2), v);
                else node.setAttribute(k, v);
            }
            for (const c of children) {
                if (c == null) continue;
                node.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
            }
            return node;
        }

        function render(pages, filterText = "") {
            const out = document.getElementById("output");
            const stats = document.getElementById("stats");
            out.innerHTML = "";
            stats.innerHTML = "";

            const filter = (filterText || "").trim().toLowerCase();
            let totalRoots = 0, totalItems = 0;

            // Stable, friendly order: by known rules, then Unmapped last
            const pageOrder = [
                ...PAGE_RULES.map(r => r.name),
                UNMAPPED
            ].filter(name => pages.has(name));

            for (const pageName of pageOrder) {
                const groups = pages.get(pageName) || [];
                if (!groups.length) continue;

                // Sort groups by rootKey
                groups.sort((a, b) => a.rootKey.localeCompare(b.rootKey));
                const pageCount = groups.reduce((acc, g) => acc + g.entries.length, 0);
                totalRoots += groups.length;
                totalItems += pageCount;

                const details = el("details", { class: "page" });
                const summary = el("summary", {},
                    el("span", {}, pageName),
                    el("span", { class: "badge", style: "margin-left:auto" }, `${groups.length} root keys • ${pageCount} items`)
                );
                details.appendChild(summary);

                const list = el("div", { class: "list" });

                for (const { rootKey, entries } of groups) {
                    // Apply filter at item-level (if any entry matches key or value display)
                    const filtered = entries.filter(e => {
                        if (!filter) return true;
                        const k = e.key.toLowerCase();
                        let v;
                        try { v = JSON.stringify(e.value).toLowerCase(); } catch { v = ""; }
                        return k.includes(filter) || v.includes(filter);
                    });
                    if (!filtered.length) continue;

                    const item = el("div", { class: "item" });
                    item.appendChild(el("div", { class: "key" }, rootKey));
                    for (const e of filtered) {
                        const key = e.key;
                        const val = safeStringify(e.value, 220);
                        const row = el("div");
                        row.appendChild(el("div", { class: "small muted" }, key));
                        row.appendChild(el("div", { class: "value" }, val));
                        item.appendChild(row);
                    }
                    list.appendChild(item);
                }

                details.appendChild(list);
                out.appendChild(details);
            }

            stats.appendChild(el("div", { class: "stat" }, `Pages: ${pageOrder.length}`));
            stats.appendChild(el("div", { class: "stat" }, `Root keys: ${totalRoots}`));
            stats.appendChild(el("div", { class: "stat" }, `Items: ${totalItems}`));
        }

        function safeStringify(v, max = 220) {
            let s;
            try {
                s = typeof v === "string" ? v : JSON.stringify(v, null, 0);
            } catch {
                s = String(v);
            }
            if (s.length > max) s = s.slice(0, max) + " …";
            return s;
        }

        // Wire UI
        const $url = document.getElementById("url");
        const $json = document.getElementById("json");
        const $filter = document.getElementById("filter");

        document.getElementById("btn-load-url").onclick = async () => {
            const url = $url.value.trim();
            if (!url) return alert("Enter a URL to a raw JSON file.");
            try {
                const res = await fetch(url, { mode: "cors" });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const text = await res.text();
                $json.value = text;
                parseAndRender();
            } catch (err) {
                alert("Fetch failed: " + err.message + "\n\nTip: use a CORS-enabled raw URL (e.g., raw.githubusercontent.com).");
            }
        };

        document.getElementById("btn-try-sample").onclick = () => {
            // Tiny sample so you see structure immediately (you can paste the full JSON afterward)
            $json.value = JSON.stringify({
                data: {
                    "view:claimType": { "view:claimingIncrease": true, "view:claimingNew": true },
                    "phoneAndEmail": { "primaryPhone": "4445551212", "emailAddress": "test@example.com" },
                    "view:bankAccount": { "bankAccountType": "Checking", "bankAccountNumber": "1233" },
                    "newDisabilities": [{ cause: "NEW", condition: "asthma" }],
                    "incident0": { incidentLocation: { country: "USA" } }
                }
            }, null, 2);
            parseAndRender();
        };

        document.getElementById("btn-parse").onclick = parseAndRender;

        document.getElementById("btn-clear").onclick = () => {
            $json.value = "";
            document.getElementById("output").innerHTML = "";
            document.getElementById("stats").innerHTML = "";
            $filter.value = "";
        };

        $filter.addEventListener("input", () => {
            try {
                const json = JSON.parse($json.value || "{}");
                const data = extractDataRoot(json) || {};
                const pages = groupByPages(data);
                render(pages, $filter.value);
            } catch { }
        });

        document.getElementById("btn-copy-report").onclick = () => {
            try {
                const json = JSON.parse($json.value || "{}");
                const data = extractDataRoot(json) || {};
                const pages = groupByPages(data);
                const order = [...PAGE_RULES.map(r => r.name), UNMAPPED].filter(n => pages.has(n));
                const lines = [];
                for (const name of order) {
                    const groups = pages.get(name) || [];
                    const count = groups.reduce((a, g) => a + g.entries.length, 0);
                    lines.push(`${name}: ${groups.length} root keys • ${count} items`);
                    for (const g of groups) lines.push(`  - ${g.rootKey}`);
                }
                navigator.clipboard.writeText(lines.join("\n"));
                alert("Copied summary to clipboard.");
            } catch (e) {
                alert("Nothing to copy yet. Parse a JSON first.");
            }
        };

        function parseAndRender() {
            let json;
            try {
                json = JSON.parse($json.value || "{}");
            } catch (err) {
                alert("Invalid JSON: " + err.message);
                return;
            }
            const data = extractDataRoot(json) || {};
            const pages = groupByPages(data);
            render(pages, $filter.value);
            // Expand all sections by default for quick scanning
            document.querySelectorAll(".page").forEach(p => p.setAttribute("open", "open"));
        }

        // Optional: prefill the URL with the vets-website maximal path (raw)
        $url.value = "https://raw.githubusercontent.com/department-of-veterans-affairs/vets-website/main/src/applications/disability-benefits/all-claims/tests/fixtures/data/transformed-data/maximal-test.json";
    </script>
</body>

</html>